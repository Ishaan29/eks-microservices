---
# ClusterRole for CI/CD operations
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cicd-deployer
rules:
  # Namespace management
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list", "create", "update", "patch"]

  # Core resources
  - apiGroups: [""]
    resources:
      - pods
      - pods/log
      - pods/exec
      - services
      - configmaps
      - secrets
      - persistentvolumeclaims
      - serviceaccounts
    verbs: ["*"]

  # Apps resources
  - apiGroups: ["apps"]
    resources:
      - deployments
      - daemonsets
      - replicasets
      - statefulsets
    verbs: ["*"]

  # Batch resources
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["*"]

  # Networking
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingresses
      - networkpolicies
    verbs: ["*"]

  # RBAC (for ServiceAccounts and cluster-wide RBAC)
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - roles
      - rolebindings
      - clusterroles
      - clusterrolebindings
    verbs: ["*"]

  # Autoscaling
  - apiGroups: ["autoscaling"]
    resources:
      - horizontalpodautoscalers
    verbs: ["*"]

  # Policy
  - apiGroups: ["policy"]
    resources:
      - poddisruptionbudgets
    verbs: ["*"]

  # Monitoring (for Prometheus/Grafana)
  - apiGroups: ["monitoring.coreos.com"]
    resources:
      - servicemonitors
      - prometheuses
      - prometheusrules
      - alertmanagers
    verbs: ["*"]

  # Events (for debugging)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]

  # Nodes (read-only for monitoring)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]

  # CustomResourceDefinitions (for Helm chart CRDs like Prometheus)
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions"]
    verbs: ["*"]

  # APIServices (for metrics and custom APIs)
  - apiGroups: ["apiregistration.k8s.io"]
    resources: ["apiservices"]
    verbs: ["*"]

  # AdmissionWebhooks
  - apiGroups: ["admissionregistration.k8s.io"]
    resources: ["validatingwebhookconfigurations", "mutatingwebhookconfigurations"]
    verbs: ["*"]

---
# ClusterRoleBinding for cicd-user
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cicd-deployer-binding
subjects:
  - kind: User
    name: cicd-user
    apiGroup: rbac.authorization.k8s.io
  - kind: Group
    name: deployers
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: cicd-deployer
  apiGroup: rbac.authorization.k8s.io

---
# Additional Role for kube-system namespace (for Fluent Bit)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cicd-system-deployer
rules:
  # Allow deployment of DaemonSets in kube-system
  - apiGroups: ["apps"]
    resources: ["daemonsets"]
    verbs: ["*"]

  # Allow ConfigMaps and Secrets in kube-system
  - apiGroups: [""]
    resources: ["configmaps", "secrets", "serviceaccounts"]
    verbs: ["*"]

  # Allow pods operations in kube-system
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]

---
# Binding for kube-system operations
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cicd-system-deployer-binding
subjects:
  - kind: User
    name: cicd-user
    apiGroup: rbac.authorization.k8s.io
  - kind: Group
    name: deployers
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: cicd-system-deployer
  apiGroup: rbac.authorization.k8s.io
